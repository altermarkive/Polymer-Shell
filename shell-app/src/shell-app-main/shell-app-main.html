<link rel="import" href="../../bower_components/polymer/polymer-element.html"/>
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html"/>
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html"/>
<link rel="import" href="../../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html"/>

<dom-module id="shell-app-main">
  <template>
    <style>
      * {
        font-family: 'Roboto', sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      :host {
        display: block;
      }

      pre {
        font-family: 'Roboto Mono', monospace;
      }

      app-toolbar {
        background-color: #4285f4;
        color: #fff;
        height: 64px
      }
      paper-button {
        font-weight: normal;
        font-size: 14px;
        max-height: 32px;
        color: #fff;
      }
      paper-input {
        width: 80%;
        color: red;
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-invalid-color: white;
        --paper-input-container-input-color: white;
      }
      </style>
    <app-header reveals>
      <app-toolbar>
        <div main-title>[[title]]</div>
        <paper-input no-label-float label="Command" value="{{command}}"></paper-input>
        <paper-button raised on-tap="runCommand">Run</paper-button>
      </app-toolbar>
    </app-header>
    <div id="history" style="position: absolute; top:64px; bottom:0; overflow-y:scroll; width:100%; color: black; background-color: white;"><pre>{{shell}}</pre><div id="terminator"></div></div>
  </template>

  <script>
    class Conduit {
      constructor(url, component) {
        var socket = this.socket = new WebSocket(url);
        socket.onopen = function() {
          console.log("Ready");
        };
        var kurna = "sdsg";
        socket.onmessage = function (message) {
          component.receive(message.data);
        };
        socket.onclose = function (event) {
          console.log(event);
        }
        socket.onerror = function (event) {
          console.log(event);
        };
      }

      send(data){
        this.socket.send(data);
      }
    }

    class ShellAppMain extends Polymer.Element {
      static get is() { return 'shell-app-main'; }

      static get properties() {
        return {
          title: {
            type: String,
            value: 'Polymer Shell'
          }
        };
      }

      runCommand(event) {
        var command = this.command;
        if ("undefined" !== typeof command) {
          this.appendLine("user@server:> " + command);
          this.conduit.send(command);
        }
      }

      appendLine(line) {
        var shell = "";
        if ("undefined" !== typeof this.shell) {
          shell = this.shell;
        }
        this.shell = shell + line + "\n";
        var terminator = this.$.terminator;
        var history = this.$.history;
        history.scrollTop = terminator.offsetTop;
      }

      receive(data){
        this.appendLine(data);
      }

      constructor() { // ready() {}
        super();      // super.ready();
        var origin = window.location.href;
        origin = origin.substring(origin.indexOf("//") + 2);
        origin = origin.substring(0, origin.indexOf("/"));
        this.conduit = new Conduit("ws://" + origin + "/ws", this);
      }
    }

    window.customElements.define(ShellAppMain.is, ShellAppMain);
  </script>
</dom-module>
